# 53.前端异常类型及捕获.53
## <a name="index"></a> 目录
- [引子](#start)
- [index 1](#index1)
  - [index 12](#index12)
- [参考资料](#reference)


## <a name="start"></a> 引子
最近对着方面有了兴致，就去花时间查找相关资料。

## 异常类型
从使用浏览器，浏览一个网页，与网页进行交互的过程，从用户的角度想一想会出现那些异常。

首先是使用浏览器一般都是基于一个操作系统，系统自身可能会出现问题，比如内存不够。这类情况归为**系统异常**。

正常打开浏览器后，访问网页的时候，可能没有网络，访问的网页提示出现服务错误，等待过程中突然断网了，将这类情况归为**网络异常**。

能够正常访问网页后，用户进行交互操作时，可能出现一种情况下点击有效，一种条件下点击无效，这类情况归为**应用异常**。

在上面比较感性的认识基础上，进一步的进行细化。

### 系统异常
系统异常情况比较少：
- 浏览器崩溃

### 网络异常
网络异常中，前端相关的有：
- XMLHttpRequest 请求异常
- Fetch 请求异常
- 静态资源加载异常
- iframe 异常
- 跨域

### 应用异常
应用异常可以用 JavaScript 中的错误对象体现出来：
- EvalError ： 与 eval() 有关的错误。
- RangeError ： 表示这个值不在允许值集或范围内。
- ReferenceError ： 表示发现一个无效的引用。
- SyntaxError ： 表示发生了解析错误。
- TypeError ：当其它类型错误都符合时，TypeError 用于指示一个不成功的操作。
- URIError ：表示用于处理 URI 的函数（encodeURI 或 decodeURl）使用方式与其定义的不兼容。

比较常见的异常可以参考 [Top 10 JavaScript errors from 1000+ projects][url-article-1] 。


## 异常捕捉
浏览器都具有某种向用户报告异常的机制，对于用户都是隐藏此类信息。对于开发者，一般在控制台可以看到相关信息。下面看下能够捕获异常的方法。
### try-catch
try-catch 使用的形式如下：
```js
try {
  // 可能导致异常的代码
} catch(error) {
  // 发生异常时的处理
}
```
测试页面见[这里][url-lab-1]，有下面的一些特点：
- `catch` 块中会接收一个包含异常信息的对象，在不同的浏览器中包含了信息可能不同，但共同有一个保存异常信息的 `message` 属性。
- 不能捕获语法异常。
- 不能捕获异步异常。
- 该方式捕获的异常，不会出现在控制台上，也不会被 `error` 事件捕获。

语法异常在开发的阶段就很容易发现，例如：
```js
try {
  var num = '333;
} catch(error) {
  console.info('try-catch：', error);
}
```
不能捕捉异步异常示例如下：
```js
try {
  setTimeout(() => {
    name.forEach(() => {});
  },1000)
} catch(error) {
  console.info('try-catch：', error);
}
```

try-catch 比较合适处理那些可以预见可能出错的地方。
### error 事件
通常将这个事件绑定在 window 上，但由于历史原因，使用 DOM 不同级别的绑定方式，会有些差别。测试页面见[这里][url-lab-1]

#### DOM0 级方式
也就是使用 `window.onerror` 指定处理程序，其特点有：
- 参数有 5 个，对应含义分别为 message-错误信息（字符串）、source-发生异常的脚本URL（字符串）、lineno-发生异常的行号（数字）、colno-发生异常的列号（数字）、error-Error 对象（对象）。
- 函数体内用 `return true` 可以阻止异常信息出现在控制台。
- 可以捕获到异步异常。
- 不能捕获到语法异常。
- 不能捕获 `try-catch` 中的异常。
- 不能捕获 script、img、input、audio、source、track 标签元素 src 属性的加载异常（HTML5 不支持的 frame 标签不讨论）。测试页面见[这里][url-lab-2]。
- 不能捕获 link 标签的加载异常，测试页面间这里[这里][url-lab-3]。

#### DOM2 级方式
也就是使用 `window.addEventListener` 指定处理程序，其特点有：
- 参数对应 1 个，是一个 `ErrorEvent` 对象，其中包含信息相对 DOM0 级更加丰富。
- 函数体内用 `preventDefault()` 方法可以阻止异常信息出现在控制台，但如果是加载资源异常无法阻止。
- 可以捕获 script、img、input、audio、source 标签元素 src 属性的加载异常（track 尝试了一下不行）。由于加载请求不会冒泡，所有需要在事件的捕获阶段监听才行。但这种方式无法知道 HTTP 的相关状态。测试页面见[这里][url-lab-2]。
- 可以捕获 link 标签的加载异常，测试页面间这里[这里][url-lab-3]。
- 可以捕获异步异常。
- 不能捕获到语法异常。
- 不能捕获到 `try-catch` 中的异常。

onerror 事件比较适合捕获预料之外的异常。

### Promise、Async/Await
Async 函数返回的总是一个 Promise，如果 Async 函数里面有异常，Promise 会 reject。所以统一的放到 Promise 里面的 catch 处理会比较方便。其特点：
- 没有写 catch 的 Promise 无法被 onerror 或 try-catch 捕获，测试页面见[这里][url-lab-1]。
- 当 Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件 [unhandledrejection][url-mdn-2] 。
- 写了 catch 后，不会触发 unhandledrejection 事件，所以建议全局增加这个事件监听。
- 本地测试验证的时候，注意跨域的限制，见 [issues1][url-issues-1]、[issues2][url-issues-2]。


### iframe
在 error 事件可以捕获到一些标签的 src 加载异常，iframe 的情况有些不一样。在网上找了一些[资料][url-stackoverflow-1]，尝试了下面的一些方法：
- 使用 window.onerror 方式，无法捕获，这是[测试页面][url-lab-4]。
- 使用 window.frames[0].onerror 方式，无法捕获，这是[测试页面][url-lab-5]。
- 在标签上绑定 onerror 事件，没有触发，无法捕获，这是[测试页面][url-lab-6]。
- 绑定 onload 事件，可以触发，但无法直接的捕获，例如一般的网站都设置了 404 页面，当 src 加载的一个网页找不到时，就会默认使用 404 网页，虽然触发了 onload 事件，但仍然不知道是不是异常。这个时候，可以间接的检测这个显示 404 页面的一些信息，来判断是否异常，例如当发现这个页面 title 里面有 404 或者 not found 之类的词汇，那就说明 iframe 加载异常。这个根据实际情况，可以设置其它检测的标识。这是[测试页面][url-lab-7]。

还有一种思路就是用一个异步请求，让服务器端判断一下是否能够正常的访问 src 的资源，如果请求返回正常，那就直接动态设置 src 的值，否则就是异常情况，直接上报即可。


###

### 跨域



<div align="right"><a href="#index">Back to top :arrow_up:</a></div>

## <a name="reference"></a> 参考资料
- [MDN Error][url-mdn-1]
- [如何优雅处理前端异常？][url-article-3]
- [Top 10 JavaScript errors from 1000+ projects][url-article-1]
- [前端异常监控解决方案研究][url-article-2]
- https://www.cnblogs.com/newh5/p/9186714.html
- http://thecodebarbarian.com/async-await-error-handling-in-javascript.html
- https://blog.fundebug.com/2019/07/24/async-await-error-handling-in-js/
- https://blog.fundebug.com/2018/03/12/top-10-javascript-errors-from-1000-projects/

[url-article-1]:https://rollbar.com/blog/top-10-javascript-errors/
[url-article-2]:https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/
[url-article-3]:http://jartto.wang/2018/11/20/js-exception-handling/index.html

[url-mdn-1]:https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Error
[url-mdn-2]:https://developer.mozilla.org/en-US/docs/Web/API/Window/unhandledrejection_event

[url-stackoverflow-1]:https://stackoverflow.com/questions/15273042/catch-error-if-iframe-src-fails-to-load-error-refused-to-display-http-ww
[url-issues-1]:https://bugs.chromium.org/p/chromium/issues/detail?id=655694
[url-issues-2]:https://github.com/webpack/webpack/issues/6099

[url-lab-1]:https://xxholic.github.io/lab/blog/53/index.html
[url-lab-2]:https://xxholic.github.io/lab/blog/53/src.html
[url-lab-3]:https://xxholic.github.io/lab/blog/53/href.html
[url-lab-4]:https://xxholic.github.io/lab/blog/53/iframe1.html
[url-lab-5]:https://xxholic.github.io/lab/blog/53/iframe2.html
[url-lab-6]:https://xxholic.github.io/lab/blog/53/iframe3.html
[url-lab-7]:https://xxholic.github.io/lab/blog/53/iframe4.html
[url-lab-8]:https://xxholic.github.io/lab/blog/53/iframe5.html