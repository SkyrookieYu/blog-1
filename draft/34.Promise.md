# 34.Promise
## <a name="index"></a> 目录
- [引子](#start)
- [问题1](#style)
  - [问题12](#link)
- [参考资料](#reference)


## <a name="situation"></a> 引子
在回顾异步编程相关的知识时，发现 Promise 里面相关的东西，比实际使用 API 要多的多。在网上也查询了一些相关的资料，虽然标准里面都已经写好了，但每篇给人的感觉还是不一样，所以整理一篇符合自己感觉的总结。

## 异步
在 JavaScript 中异步机制还是很常用的，比如请求使用的 ajax、setTimeout 延时处理、打印日志的 console 。在使用异步时，表现出来的是现在运行的一部分和将来运行的一部分之间的关系。在“现在”和“将来”之间的这段空隙，在很多的程序中都需要考虑如何管理。在 JavaScript 中使用了“事件循环”的机制来处理异步。所有异步任务会进入到“任务队列”，一旦有事件需要运行，时间循环就会运行，直到队列清空。用户交互、IO 和定时器会向事件队列中加入事件。任意时刻，一次只能从队列中处理一个事件。执行事件的时候，可能直接或间接的引发一个或多个后续事件。

## 回调
在处理异步逻辑时，最常用的方式是回调。回调在异步中的使用有两个主要缺陷：缺乏顺序性和可信任性。

### 缺乏顺序性
工作过一段时间的人，很有可能遇到这样的代码：
```javascript
ajax('https://url1',function(data) {
  doSomething1();
  if (data === 200) {
    doSomething3();
    ajax('https://url2',function(data2) {
      if (data2 === 200) {
        ajax('https://url3',function() {
          doSomething4();
        });
      } else {
        doSomething5();
      }
    });
  } else {
    doSomething2();
  }
})
```
这种代码常被称为回调地狱，在维护和阅读时，都需要花费相当的精力。

### 缺乏可信任性
看下面一个例子：
```javascript
doSomethingA();

ajax('https://url',function() {
  doSomethingC()
});

doSomethingB();

```
在这段程序中，doSomethingA 和 doSomethingB 发生在现在，在主程序的控制下，而 doSomethingC 发生在将来，在第三方的控制下。这种把自己程序一部分的执行控制交给某个第三方的情况，被称为**控制反转**。一段时间过后，在某一天，有人反馈 doSomethingC 重复执行了 3 次。为了防止这种情况，进行了下面的处理：
```javascript
var isDone = false;

ajax('https://url',function() {
  if (!isDone) {
    isDone = true;
    doSomethingC()
  }
});
```
这样似乎就解决了问题，但再想一想，就会发现还可能出现下面的问题：
- 根本没有调用；
- 调用超时；
- 调用过早；
- 等等

为此，我们需要构建对应的机制，针对这些情况进行处理，不管是自己控制下的代码，还是第三方的代码。这些看似合理的处理，表现出来的是回调缺乏可信任性。

如果我们能够知道调用何时结束，然后由我们自己的代码决定接下来要做的事情，那将会是样？这就是 Promise 要做的事情。

## Promise


## <a name="reference"></a> 参考资料
- [MDN Promise][url-mdn-promise]
- [Promises/A+][url-promisesaplus]
- [promises-unwrapping][url-promises-unwrapping]
- [ECMAScript 6 入门][url-ruanyifeng-promises]
- [Async JavaScript: From Callbacks, to Promises, to Async/Await][url-tylermcginnis-promises]

[url-base]:https://xxholic.github.io/blog/draft

[url-mdn-promise]:https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise
[url-promisesaplus]:https://promisesaplus.com/
[url-promises-unwrapping]:https://github.com/domenic/promises-unwrapping
[url-ruanyifeng-promises]:http://es6.ruanyifeng.com/#docs/promise
[url-tylermcginnis-promises]:https://tylermcginnis.com/async-javascript-from-callbacks-to-promises-to-async-await/