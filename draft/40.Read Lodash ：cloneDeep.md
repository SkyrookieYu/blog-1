# 40.Read Lodash ：cloneDeep
## <a name="index"></a> 目录
- [引子](#start)
- [基本概念](#concept)
- [主要实现](#achieve)
- [思考](#think)
- [参考资料](#reference)


## <a name="start"></a> 引子
碰到深拷贝时循环引用的问题，就去看了下 Lodash 中深拷贝 cloneDeep 的实现。

Lodash 版本 4.17.15 。

## <a name="concept"></a> 简介
Lodash 是一个一致性、模块化、高性能的 JavaScript 实用工具库。以下面的例子看深拷贝的逻辑。
```js
var obj1 = {c:'apple'};
var obj2 = {};
obj1.a = obj2;
obj2.b = obj1;
var copy = _.cloneDeep(a);
```

<div align="right"><a href="#index">Back to top :arrow_up:</a></div>

## <a name="achieve"></a> 主要实现
找到相关方法：
```js
  var CLONE_DEEP_FLAG = 1,
      CLONE_FLAT_FLAG = 2,
      CLONE_SYMBOLS_FLAG = 4;

  function cloneDeep(value) {
    return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG);
  }
```
在使用 cloneDeep 时，调用了 baseClone 方法，其中传递的第二个参数 `CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG`，使用了按位运算符。

### ListCache
ListCache 保存缓存的对象数组，提供的方法有：
- clear：重置数据 __data__ 和 size
- delete：根据 key 删除
- get：根据 key 获取值
- has：根据 key 判断是否有值
- set：设置 key 和对应 value

### Stack
Stack 创建一个缓存对象的栈，提供下面的方法：
- clear：清空数据
- delete：根据 key 删除
- get：根据 key 获取值
- has：根据 key 判断是否有值
- set：设置 key 和对应 value

初始化生成的数据是基于 ListCache，这些方法也是基于 ListCache 的方法，

### MapCache

### 第一次初始化时
```js
stack || (stack = new Stack);
// 结果
// stack = {
//   size:0,
//   __data__:{
//     __data__:[],
//     size:0
//   }
// }

// 没有找到，返回 undefined
stack.get(value)
      if (stacked) {
        return stacked;
      }
      stack.set(value, result);
// set 后
stack = {
  size:1,
  __data__:{
    __data__:[
      [{a:{b:{}},{}]
    ],
    size:1
  }
}
```

### 第二次
```js
stack = {
  size:2,
  __data__:{
    __data__:[
      [{a:{b:{}},{}],
      [{b:{a:{}},{}]
    ],
    size:2
  }
}
```




<div align="right"><a href="#index">Back to top :arrow_up:</a></div>


## <a name="reference"></a> 参考资料
- [Lodash Github][url-github-lodash]
- [cloneDeep][url-docs-clonedeep]

[url-base]:https://xxholic.github.io/blog/draft

[url-github-lodash]:https://github.com/lodash/lodash
[url-docs-clonedeep]:https://lodash.com/docs/4.17.15#cloneDeep
[url-mdn-bitwise]:https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators






